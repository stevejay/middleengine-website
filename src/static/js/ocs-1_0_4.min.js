!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Octomments=t()}(this,function(){"use strict";function c(e){return function(e){if(Array.isArray(e))return e}(e)||t(e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function a(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||t(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function t(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function s(){return!0===function(){var e="test";try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}()?localStorage:{setItem:function(){},getITem:function(){},removeItem:function(){}}}function u(e,t){t=t||window.location.href,e=e.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]".concat(e,"(=([^&#]*)|&|#|$)")).exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}function f(t){return["code","error","error_description","error_uri","t"].forEach(function(e){t=t.replace(new RegExp("[?&]".concat(e,"=[^&]+")),"")}),t}function p(e){return{id:e.id,url:e.html_url,author:{login:e.user.login,avatarUrl:e.user.avatar_url,url:e.user.html_url},body:e.body_html,createdAt:e.created_at,updatedAt:e.updated_at}}var l="ERROR",m="USER_LOADING",g="USER_NONE",d="USER_LOADED",n="COMMENTS_LOADING",w="COMMENTS_LOADED",h="COMMENT_SAVING",v="COMMENT_SAVED",E="OCTOMMENTS_USER",y=[l,n,w,h,m,g,d,v];function b(i,e){var c=i.notify,t=i.options,a=i.error,s=t.endpoints,u=t.issueNumber,f=t.github,l=!!s,m=new Error("Error getting comments for issue #".concat(u,".")),r=new Error("Issue #".concat(u," doesn't exists."));function d(e){console.error(e),a(m,2)}function h(n){return function(e,t){if(t)a(m,2);else if(e.ok)n(e);else{if(404===e.status)return a(r,1);n(e)}}}c(n),function r(e){var o=0<arguments.length&&void 0!==e?e:1,t="https://api.github.com/repos/".concat(f.owner,"/").concat(f.repo,"/issues/").concat(u,"/comments?page=").concat(o);fetch(t,{headers:i.getHeaders()}).then(h(function(e){if(!e.ok)return 401===e.status?(i.logout(!1),c(g),void r(o)):403===e.status?l?void fetch("".concat(s.issue,"?owner=").concat(f.owner,"&repo=").concat(f.repo,"&number=").concat(u)).then(h(function(e){e.ok?e.json().then(function(e){var t=e.issue.comments;i.data={comments:i.data.comments.concat(t),pagination:null},c(w,t,null)}).catch(function(e){console.error(e),a(new Error("Error parsing the API response"),3)}):a(m,2)})).catch(d):a(new Error("Rate limit exceeded."),4):a(m,2);var t=e.headers.get("Link"),n=null;t&&(n=function(e){var t=e.split(","),n={};for(var r in t){var o=t[r],i={};i.name=o.match(/rel=\"([^\"]*)/)[1],i.url=o.match(/<([^>]*)/)[1],i.page=parseInt(o.match(/page=(\d+).*$/)[1],10),n[i.name]=i}return n}(t)),e.json().then(function(e){var t=e.map(p);i.data={comments:i.data.comments.concat(t),pagination:n},c(w,t,n)}).catch(d)}))}(e)}function S(n,e){var r=n.notify,o=n.error,t=n.options,i=t.issueNumber,c=t.github,a=new Error("Adding a new comment failed.");r(h);var s,u="https://api.github.com/repos/".concat(c.owner,"/").concat(c.repo,"/issues/").concat(i,"/comments");function f(e){console.error(e),o(a,10)}fetch(u,{method:"POST",headers:n.getHeaders(),body:JSON.stringify({body:e})}).then((s=function(e){r(v,[p(e)])},function(e,t){return t?o(a,8):e.ok?void e.json().then(function(e){e?s(e):o(new Error("Parsing new-comment response failed."),10)}).catch(f):401===e.status?(n.logout(!1),r(g),o(new Error("Not authorized. Log in again."),9)):403===e.status?o(new Error("Rate limit exceeded."),4):o(a,8)})).catch(f)}function r(o){if(!o)throw new Error("Octomments options required.");if(!o.github||!o.github.owner||!o.github.repo)throw new Error("`options.github` is missing or incomplete.");if(!o.issueNumber)throw new Error("`options.issueNumber` is missing.");o.endpoints||(o.endpoints={issue:"https://ocs.now.sh/octomments/issue",token:"https://ocs.now.sh/octomments/token"}),o.debug&&console.log("Octomments started with: ",JSON.stringify(o,null,2));var i={},n={user:null,data:{comments:[],pagination:null},options:o,LS:s(),error:function(e,t){n.notify(l,e,t)},notify:function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];o.debug&&console.log(e,n),i[e]&&i[e].forEach(function(e){return e.apply(void 0,n)})}};if(n.initUser=function(){return function(n){function r(){return history.replaceState({},document.title,f(location.href))}var o=n.notify,i=n.error,e=n.generateNewCommentURL(),t=n.LS.getItem(E);if(t)try{n.user=JSON.parse(t),o(d,n.user,!1)}catch(e){console.error(e),i(new Error("Corrupted data in local storage."),5)}else if(u("t")){var c=u("t");n.user={token:c},o(m),fetch("https://api.github.com/user",{headers:n.getHeaders()}).then(function(e,t){t||!e.ok?(t&&console.error(t),r(),i(new Error("Problem getting user's info."),6)):e.json().then(function(e){n.user={token:n.user.token,login:e.login,avatarUrl:e.avatar_url,url:e.html_url,name:e.name},r(),n.LS.setItem(E,JSON.stringify(n.user)),o(d,n.user,!0)}).catch(function(e){console.error(e),i(new Error("Problem parsing access token response."),7)})}).catch(function(e){console.error(e),i(new Error("Problem getting access token."),6)})}else o(g,e)}(n)},n.initComments=function(){return b(n)},n.logout=function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];n.user=null,n.LS.removeItem(E),e&&location.reload()},n.add=function(e){if(!n.user)throw new Error("No user logged in.");S(n,e)},n.off=function(e){return delete i[e],this},n.on=function(e,t){return i[e]||(i[e]=[]),i[e].push(t),this},n.init=function(){n.initUser(),n.initComments()},n.page=function(e){b(n,e)},n.generateNewCommentURL=function(){return e=o.endpoints.token,t=f(window.location.href),"".concat(e,"?redirect=").concat(encodeURI(t));var e,t},n.getHeaders=function(){var e={"Content-Type":"application/json",Accept:"application/vnd.github.v3.html+json"};return n.user&&n.user.token&&(e.Authorization="token ".concat(n.user.token)),e},y.forEach(function(e){return n[e]=e}),o.renderer){var e=c(o.renderer),t=e[0],r=e.slice(1);t.apply(void 0,[n].concat(a(r)))}return n}return y.forEach(function(e){return r[e]=e}),r.version="1.0.4",r});!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(n=n||self).OctommentsRenderer=t()}(this,function(){"use strict";var u="O_",v=function(n){var t=0<arguments.length&&void 0!==n?n:24;return'<svg width="'.concat(t,'" height="').concat(t,'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>')};function s(n){return document.querySelector(n)}function g(n,t,o,e){var a=0<arguments.length&&void 0!==n?n:"div",c=1<arguments.length&&void 0!==t?t:"",i=2<arguments.length&&void 0!==o?o:null,r=3<arguments.length&&void 0!==e?e:null,s=document.createElement(a);return s.setAttribute("class",u+c),i&&i.appendChild(s),r&&(s.innerHTML=r),s}function f(n){for(;n.firstChild;)n.removeChild(n.firstChild)}function h(n,t){var o=s(n);o?o.addEventListener("click",t):console.warn("Octomments: ".concat(n," element doesn't exists in the DOM"))}function i(e,o){var a,t={},n=o.options,c=n.issueNumber,i=n.github,r=i.owner,s=i.repo,m="https://github.com/".concat(r,"/").concat(s,"/issues/").concat(c),d=[];function l(n){f(e),g("div","error",e,"<div>".concat(n,"</div>"))}return t.loading=function(){0===d.length?(f(e),g("div","summary",e,'\n      <div>Loading comments ...</div>\n        <div>\n          <a href="'.concat(m,'" target="_blank">\n            ').concat(v(14),"\n          </a>\n        </div>"))):a.innerHTML='\n        <div></div>\n        <div class="'.concat(u,'more-comments-loading"><small>loading ...</small></div>\n      ')},t.noComments=function(){f(e)},t.newComment=function(n){t.data(n)},t.data=function(n,t){d=d.concat(n),f(e),g("div","summary",e,'\n        <div id="'.concat(u,'num-of-comments">').concat(d.length," comment").concat(1!==d.length?"s":"",'</div>\n        <div>\n          <a href="').concat(m,'" target="_blank">\n            ').concat(v(14),"\n          </a>\n        </div>\n      ")),d.forEach(function(n){var t,o;g("div","comment",e,'\n          <div class="'.concat(u,'comment_left">\n            <img src="').concat(n.author.avatarUrl,'" />\n          </div>\n          <div class="').concat(u,'comment_right">\n            <div class="').concat(u,'comment_heading">\n              <strong>').concat(n.author.login,"</strong>\n              <small> ~ ").concat((t=n.updatedAt,o=new Date(t),"".concat(o.getDate(),".").concat(o.getMonth()+1,".").concat(o.getFullYear())),'</small>\n              <a href="').concat(n.url,'" target="_blank" class="').concat(u,'right">').concat(v(16),'</a>\n            </div>\n            <div class="').concat(u,'comment_body">\n              ').concat(n.body,"\n            </div>\n          </div>\n        "))}),t&&t.next&&(a=g("div","comment ".concat(u,"more-comments"),e,'\n          <div></div>\n          <div>\n            <a href="javascript:void(0);" id="'.concat(u,'more-comments-link">\n              <small>... load more comments</small>\n            </a>\n          </div>\n        ')),h("#".concat(u,"more-comments-link"),function(){o.page(t.next.page)}))},o.on(o.ERROR,function(n,t){console.log("-errror",n,t),1===t?l("Issue <strong>#".concat(number,"</strong> doesn't exists at <a href=\"https://github.com/").concat(r,"/").concat(s,'/issues" target="_blank">').concat(s," repo</a>.")):2!==t&&3!==t&&4!==t||(l('There is a problem fetching the comments. Wait a bit and click <a href="javascript:void(0);" id="'.concat(u,'comments_try_again">here</a> to try again.')),h("#".concat(u,"comments_try_again"),o.initComments))}),t}var m="OCTOMMENTS_NEW_COMMENT_TEXT";function r(a,r){var e={};function c(n){var t,o,e,a=r.LS.getItem(m)||"",c=s("#".concat(u,"_submit_comment")),i=s("#".concat(u,"_textarea"));h("#".concat(u,"_submit_comment"),function(){c.disabled=!0,n(i.value)}),t="#".concat(u,"_textarea"),o=function(n){""===n.target.value?c.disabled=!0:c.disabled=!1,r.LS.setItem(m,n.target.value)},(e=s(t))?e.addEventListener("keyup",o):console.warn("Octomments: ".concat(t," element doesn't exists in the DOM")),""===a?c.disabled=!0:i.value=a}function o(n,t,o){var e=2<arguments.length&&void 0!==o?o:a;return(!(1<arguments.length&&void 0!==t)||t)&&f(a),g("div","error_user",e,"<div>".concat(n,"</div>"))}return a.style.display="none",e.loading=function(){f(a),g("small","comment",a,'\n      <div></div>\n      <div class="'.concat(u,'loading-user"><small>Loading user ...</small></div>\n      '))},e.noUser=function(n){f(a),g("div","comment",a,'\n        <div class="'.concat(u,'comment_left" id="').concat(u,'new_comment">\n          <div class="').concat(u,'avatar_placeholder"></div>\n        </div>\n        <div class="').concat(u,'comment_right">\n          <textarea id="').concat(u,'_textarea" placeholder="I think ..."></textarea>\n          <button id="').concat(u,'_submit_comment">Log in and comment</button>\n        </div>\n      ')),c(function(){window.location.href=n})},e.form=function(n,t){var o=r.user;if(!o)return e.loading();f(a),g("div","comment",a,'\n        <div class="'.concat(u,'comment_left" id="').concat(u,'new_comment">\n          <img src="').concat(o.avatarUrl,'" />\n        </div>\n        <div class="').concat(u,'comment_right">\n          <textarea id="').concat(u,'_textarea" placeholder="I think ..."></textarea>\n          <button id="').concat(u,'_submit_comment">Comment</button>\n          <a href="javascript:void(0);" id="').concat(u,'logout" class="').concat(u,"right ").concat(u,'logout"><small>Log out</small></a>\n        </div>\n      ')),c(function(n){r.add(n)}),h("#".concat(u,"logout"),function(){r.logout()}),t&&setTimeout(function(){s("#".concat(u,"_textarea")).focus()},100)},e.newCommentSaved=function(){r.LS.removeItem(m)},r.on(r.ERROR,function(n,t){if(1===t)f(a);else if(5===t)r.logout(!1),e.noUser(r.generateNewCommentURL());else if(6===t||7===t||10===t)o('There is a problem initializing your user. Wait a bit and click <a href="javascript:void(0);" id="'.concat(u,'user_try_again">here</a> to try again.')),h("#".concat(u,"user_try_again"),r.initUser);else if(8===t){o("There is a problem posting your comment. Please try again in a couple of minutes.",!1,s(".".concat(u,"comment_right"))).style.marginTop="1em"}else 9===t&&(r.logout(!1),o('Not authorized. Click <a href="javascript:void(0);" id="'.concat(u,'user_login">here</a> to login again.')),h("#".concat(u,"user_login"),r.initUser))}),r.on(r.COMMENTS_LOADED,function(){a.style.display="block"}),e}return function(n,t){var o=s(t);if(!o)throw new Error("Octomments: invalid container selector.");var e=g("div","root",o),a=i(g("div","comments",e),n),c=r(g("div","new-comment",e),n);n.on(n.COMMENTS_LOADING,a.loading).on(n.COMMENTS_LOADED,a.data).on(n.USER_LOADING,c.loading).on(n.USER_NONE,c.noUser).on(n.USER_LOADED,c.form).on(n.COMMENT_SAVING,function(){s("#".concat(u,"new_comment")).style.opacity=.4;var n=s("#".concat(u,"_submit_comment")),t=s("#".concat(u,"_textarea"));n.disabled=!0,t.disabled=!0,n.innerHTML="Posting your comment ..."}).on(n.COMMENT_SAVED,function(n){c.newCommentSaved(),c.form(),a.newComment(n)})}});